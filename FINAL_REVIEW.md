# Hoowoo 최종 검토 – 현재 작동 방식 정리

## 1. 하드웨어·핀 (Arduino Mega)

| 용도 | 핀 | 비고 |
|------|-----|------|
| RTC DS1302 | CLK 22, DAT 23, RST 24 | virtuabotixRTC |
| NeoPixel | 25 (1개) | GRB, 800kHz |
| 부저 | 26 | tone/noTone |
| IR 센서 (HW-488) | 27 | 디지털, INPUT_PULLUP |
| FND (TM1637) | CLK 28, DIO 29 | 4자리 7세그, HH:MM |
| HC-06 블루투스 | Serial1 (TX1/RX1) | 9600 baud |

---

## 2. Arduino → 앱 (블루투스 전송)

- **1초마다**  
  `Time: HH:MM:SS` (RTC 시·분·초, 줄바꿈 포함)  
  → 앱에서 RTC 현재 시간 표시용.

- **100ms마다**  
  `0`~`100` 한 줄 (숫자만)  
  → **RPM 방식 호흡값**: “최근 1초 동안 IR 펄스(감지) 횟수”를 0~100으로 매핑한 값.  
  - 1초에 10회 감지 = 100, 5회 = 50 (`PULSES_PER_100 = 10`).  
  - 앱: 미니게임 배 속도 + “성공” 다이얼로그(값 ≥ 90) 트리거.

---

## 3. 앱 → Arduino (블루투스 수신)

- **`RGB:r,g,b\n`**  
  NeoPixel 색 설정. 한 번 설정하면 전원 유지 동안 해당 색 유지.

- **`SET_ALARM:YYYY:MM:DD:HH:MM\n`**  
  알람 날짜·시간 설정.  
  - 기존 알람 울림 중이면 끔.  
  - `alarmTriggered` 초기화 → 해당 날짜·시간에 다시 울릴 수 있음.

- **`MELODY:0|1|2\n`**  
  벨소리 선택.  
  - 0: 클래식(띵동), 1: 아침멜로디(도레미파솔), 2: 디지털비프(삐삐삐).

---

## 4. 호흡 감지 (RPM) – 상세

- **센서**: HW-488 디지털. HIGH→LOW 엣지 = 한 번 “감지”.
- **디바운스**: 80ms 이내 중복 엣지 무시.
- **원형 버퍼**: 최근 펄스 32개 시각 저장 (`pulseTimes[32]`).
- **전송값 계산**:  
  - 매 100ms마다 “현재 시각 − 1초” 이후의 펄스 개수 `count` 계산.  
  - `sendVal = count * (100 / PULSES_PER_100)`, 최대 100.  
  - 즉 “1초당 감지 횟수”에 비례하는 0~100 (RPM 스타일).

---

## 5. 알람

- **조건**: 설정된 날·월·일·시·분이 RTC와 **전부 일치**할 때만 울림.
- **울리는 중**: 선택된 멜로디 반복 재생 (음 높이·길이 배열로 순환).
- **끄기**:  
  - 알람 울리는 동안 **한 번이라도** IR 펄스(호흡 감지)가 나오면  
    `noTone`, `alarmRinging = false`, `alarmTriggered = true` → 부저 중지, 그날은 더 안 울림.
- **앱**: 날짜·시간 선택 후 “알람 시간 전송” 시 `MELODY:index` 먼저 보내고, 이어서 `SET_ALARM:...` 전송.

---

## 6. FND (화면 시간)

- **조건**: `FND_USE_TM1637 == 1` 일 때만 동작.
- **표시**: RTC 시·분을 **HH:MM** 형태로 4자리 7세그에 표시 (가운데 콜론 포함).
- **갱신**: 500ms마다 `fndDisplayTime(hours, minutes)` 호출 → 평소에는 항상 현재 시간 표시.

---

## 7. NeoPixel

- **초기**: 꺼짐. `neoColorSet == false` 이면 표시 안 함.
- **동작**: `RGB:r,g,b` 수신 시 해당 색으로 설정 후, 루프에서 매번 `setPixelColor` + `show()` 로 유지.

---

## 8. 앱 동작 요약

| 화면/기능 | 동작 |
|-----------|------|
| 연결 | 기기 선택 다이얼로그에서 HC-06 등 선택 후 연결. 자동 연결 없음. |
| 상태 카드 | 연결 여부, RTC 시간(`Time:` 파싱) 표시. |
| 호흡 미니게임 | 0~100 숫자 한 줄을 “RPM 호흡값”으로 해석. 값이 클수록 배 속도·크기·기울기 증가. 85:15 스무딩으로 급격한 감쇠 완화. |
| 성공 다이얼로그 | 호흡값 ≥ 90 이면 “성공! / 알람 끄기 성공!” 표시. (실제 알람 끄기는 아두이노에서 호흡 감지 시 수행.) |
| 알람 설정 | 날짜·시간 선택, 벨소리 0/1/2 선택 후 “알람 시간 전송” → MELODY → SET_ALARM 순 전송. |
| LED 색상 | 색 선택 후 전송 시 `RGB:r,g,b` 전송. |

---

## 9. 데이터 구분 (앱 수신)

- **`Time:` 으로 시작** → RTC 시간으로 파싱, 상태 카드 갱신.
- **그 외 한 줄이 숫자(0~100)** → 호흡(RPM) 값으로 파싱, 미니게임·성공 다이얼로그에 사용.

---

## 10. 검토 결과 요약

- **RPM 호흡**: 1초당 펄스 수 → 0~100 전송·파싱·미니게임 반영 일치.
- **알람**: 날짜+시간 일치 시 울림, 호흡 한 번 감지 시 끔, 멜로디 3종 앱과 동기화됨.
- **FND**: TM1637 가정 시 평소 HH:MM 표시, 500ms 갱신.
- **NeoPixel**: RGB 명령 수신 후 해당 색 유지.
- **블루투스**: 줄 단위(`\n`) 수신, Time vs 숫자 구분 명확.

**참고**: 성공 다이얼로그는 “미니게임에서 호흡값 90 이상”으로 뜨며, 실제 알람이 울리는 순간에 호흡으로 끈 것은 아두이노에서만 처리됩니다. 앱은 “호흡이 세다”는 피드백용으로 사용됩니다.
