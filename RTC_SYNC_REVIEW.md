# RTC 동기화 로직 검토 (2026년 반영)

## 1. 앱 → 아두이노 전송

- **시점:** 블루투스 연결 성공 후 **500ms 지연** 뒤 `sendSetRTC(DateTime.now())` 1회 호출.
- **형식:** `SET_RTC:YYYY:MM:DD:HH:MM:SS:DOW`
  - `DateTime.now()` → 2026년이면 YYYY=**2026** 그대로 전송.
  - 월·일·시·분·초·요일(Dart 1=월~7=일) 모두 포함.

→ **연도 2026이 그대로 전달되는 구조라 문제 없음.**

---

## 2. 아두이노 수신·검증

- **파싱:** `v[0]=연도, v[1]=월, v[2]=일, v[3]=시, v[4]=분, v[5]=초, v[6]=요일`.
- **검증:**  
  `연도 2000~2099`, `월 1~12`, `일 1~31`, `시 0~23`, `분·초 0~59`, `요일 1~7`.

→ **2026이 들어오면 v[0]=2026로 통과.**

---

## 3. setDS1302Time 호출

- **인자 순서:** `(초, 분, 시, 요일, 일, 월, 연도)` (virtuabotixRTC.h: seconds, minutes, hours, dayofweek, dayofmonth, month, **int year**).
- **연도:** 라이브러리 시그니처가 `int year` 이므로 **풀 연도(2026)** 를 그대로 전달.  
  - DS1302 칩은 0~99만 저장하므로, 라이브러리 내부에서 `year % 100` 등으로 변환해 기록하는 경우가 많음.  
  - 이전에 `y % 100`(26)만 넘기면, 라이브러리 버전에 따라 연도 레지스터에 제대로 쓰이지 않아 **시간/일/월은 맞고 연도만 2099로 남는** 현상이 나올 수 있음.  
  - 따라서 **연도는 2026처럼 풀 연도로 넘기는 것이 안전.**
- **요일:** Dart 1=월~7=일 → DS1302 1=일~7=토로 변환 `dow = (v[6] == 7) ? 1 : (v[6] + 1)` → 올바름.

→ **연도만 안 맞던 경우는 연도 인자를 풀 연도(2026)로 보내도록 수정한 상태.**

---

## 4. 2099가 나왔을 수 있는 이유

- RTC에 **한 번도 동기화가 안 됐을 때** DS1302/보드 기본값이나 전원 초기값이 **99**로 들어가 2099로 보였을 가능성이 큼.
- 또는 연결 직후 전송이 너무 빨라 아두이노가 **SET_RTC 패킷을 못 받았을** 수 있음 → 그래서 **500ms 지연** 추가한 상태.

---

## 5. 결론

- **연도:** 앱은 2026을 그대로 보내고, 아두이노는 26으로 RTC에 쓰므로 **2026년이 맞게 반영되는 로직**임.
- **지연·로그:** 연결 후 500ms 뒤 전송 + `[RTC] 동기화됨 2026/x/x ...` 로그로 동기화 여부 확인 가능.
- **추가 권장:** 동기화 후 시리얼에서 RTC를 한 번 읽어서 `myRTC.year`가 26 또는 2026으로 나오는지 확인하면, 2099가 아닌 2026으로 바뀌었는지 최종 검증할 수 있음.

**현재 수정한 RTC 동기화 로직은 2026년을 올바르게 반영하도록 되어 있음.**
